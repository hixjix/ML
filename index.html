<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AIoT æ°´è³ªç›£æŽ§ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; padding: 20px; }
        .card { background: white; max-width: 800px; margin: 0 auto; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status { padding: 15px; color: white; border-radius: 8px; font-size: 1.5em; font-weight: bold; margin-bottom: 20px;}
        .normal { background: #28a745; }
        .alert { background: #dc3545; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }
        .data-row { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .data-box h3 { color: #666; font-size: 0.9em; margin: 0; }
        .data-box p { font-size: 2em; font-weight: bold; margin: 5px 0; color: #333; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ðŸ¤– AIoT æ™ºæ…§æ°´è³ªç›£æŽ§ä¸­å¿ƒ</h2>
        <div id="statusBox" class="status normal">ç³»çµ±å¾…å‘½ä¸­...</div>
        
        <div class="data-row">
            <div class="data-box">
                <h3>COD æ¿ƒåº¦</h3>
                <p id="codVal">--</p>
            </div>
            <div class="data-box">
                <h3>pH å€¼</h3>
                <p id="phVal">--</p>
            </div>
            <div class="data-box">
                <h3>æ°´é–˜ç‹€æ…‹</h3>
                <p id="gateVal">--</p>
            </div>
        </div>
        <canvas id="chart"></canvas>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ çš„ Ngrok ç¶²å€ â˜…â˜…â˜…
        const API_BASE = "https://elidia-pharmacopoeial-perpendicularly.ngrok-free.dev/"; 

        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'COD', borderColor: '#007bff', data: [] },
                    { label: 'pH', borderColor: '#ffc107', data: [] }
                ]
            }
        });

        async function updateData() {
            try {
                // å‘¼å«æ–°çš„ Dashboard API
                const res = await fetch(`${API_BASE}/api/dashboard/monitor`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });
                const data = await res.json();

                document.getElementById('codVal').innerText = data.cod;
                document.getElementById('phVal').innerText = data.ph;
                document.getElementById('gateVal').innerText = data.sluice_gate ? "ðŸ›‘ é–‹å•ŸæŽ’æ´ª" : "ðŸ”’ é—œé–‰";

                const box = document.getElementById('statusBox');
                if (data.alert) {
                    box.innerText = "âš ï¸ è­¦å‘Šï¼šæ°´è³ªç•°å¸¸";
                    box.className = "status alert";
                } else {
                    box.innerText = "âœ… æ°´è³ªæ­£å¸¸";
                    box.className = "status normal";
                }

                // æ›´æ–°åœ–è¡¨
                if (chart.data.labels.slice(-1)[0] !== data.timestamp) {
                    chart.data.labels.push(data.timestamp);
                    chart.data.datasets[0].data.push(data.cod);
                    chart.data.datasets[1].data.push(data.ph);
                    if (chart.data.labels.length > 20) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                        chart.data.datasets[1].data.shift();
                    }
                    chart.update();
                }
            } catch (e) { console.error(e); }
        }
        setInterval(updateData, 1000);
    </script>
</body>
</html>