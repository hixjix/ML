<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AIoT æ°´è³ªç›£æ§ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; padding: 20px; }
        .card { background: white; max-width: 800px; margin: 0 auto; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status { padding: 15px; color: white; border-radius: 8px; font-size: 1.5em; font-weight: bold; margin-bottom: 20px;}
        .normal { background: #28a745; }
        .alert { background: #dc3545; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }
        .data-row { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .data-box h3 { color: #666; font-size: 0.9em; margin: 0; }
        .data-box p { font-size: 2em; font-weight: bold; margin: 5px 0; color: #333; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ¤– AIoT æ™ºæ…§æ°´è³ªç›£æ§ä¸­å¿ƒ</h2>
        <div id="statusBox" class="status normal">é€£ç·šä¸­...</div>
        
        <div class="data-row">
            <div class="data-box">
                <h3>COD æ¿ƒåº¦</h3>
                <p id="codVal">--</p>
            </div>
            <div class="data-box">
                <h3>pH å€¼</h3>
                <p id="phVal">--</p>
            </div>
            <div class="data-box">
                <h3>æ°´é–˜ç‹€æ…‹</h3>
                <p id="gateVal">--</p>
            </div>
        </div>
        <canvas id="chart"></canvas>
    </div>

    <script>
        // ==========================================
        // â˜…â˜…â˜… è«‹ç¢ºèªé€™è£¡å¡«çš„æ˜¯ä½ æœ€æ–°çš„ Ngrok ç¶²å€ â˜…â˜…â˜…
        // ä¾æ“šä½ çš„æˆªåœ–ï¼Œç›®å‰æ˜¯é€™å€‹ï¼Œä½†å¦‚æœ Colab é‡é–‹éå°±æœƒè®Šï¼
        const API_BASE = "https://elidia-pharmacopoeial-perpendicularly.ngrok-free.dev"; 
        // ==========================================

        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'COD', borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)', fill: true, data: [] },
                    { label: 'pH', borderColor: '#ffc107', backgroundColor: 'rgba(255,193,7,0.1)', fill: false, data: [] }
                ]
            },
            options: {
                animation: false, // é—œé–‰å‹•ç•«è®“æ›´æ–°æ›´é †æš¢
                interaction: { mode: 'index', intersect: false },
            }
        });

        async function updateData() {
            try {
                // åŠ å…¥ headers ä¾†ç¹é Ngrok çš„ç€è¦½å™¨è­¦å‘Šé é¢
                const res = await fetch(`${API_BASE}/api/dashboard/monitor`, {
                    headers: new Headers({
                        "ngrok-skip-browser-warning": "69420",
                    }),
                });

                if (!res.ok) throw new Error("API å›å‚³éŒ¯èª¤");

                const data = await res.json();

                // æ›´æ–°æ•¸å€¼
                document.getElementById('codVal').innerText = data.cod;
                document.getElementById('phVal').innerText = data.ph;
                document.getElementById('gateVal').innerText = data.sluice_gate ? "ğŸ›‘ é–‹å•Ÿæ’æ´ª" : "ğŸ”’ é—œé–‰";

                // æ›´æ–°ç‹€æ…‹ç‡ˆè™Ÿ
                const box = document.getElementById('statusBox');
                if (data.alert) {
                    box.innerText = "âš ï¸ è­¦å‘Šï¼šæ°´è³ªç•°å¸¸";
                    box.className = "status alert";
                } else {
                    box.innerText = "âœ… æ°´è³ªæ­£å¸¸";
                    box.className = "status normal";
                }

                // æ›´æ–°åœ–è¡¨
                // å¦‚æœæ™‚é–“æˆ³è¨˜è·Ÿä¸Šä¸€ç­†ä¸åŒï¼Œæ‰æ›´æ–°åœ–è¡¨
                if (chart.data.labels.length === 0 || chart.data.labels.slice(-1)[0] !== data.timestamp) {
                    chart.data.labels.push(data.timestamp);
                    chart.data.datasets[0].data.push(data.cod);
                    chart.data.datasets[1].data.push(data.ph);
                    
                    // åªä¿ç•™æœ€å¾Œ 20 ç­†è³‡æ–™
                    if (chart.data.labels.length > 20) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                        chart.data.datasets[1].data.shift();
                    }
                    chart.update();
                }

            } catch (e) { 
                console.error("é€£ç·šéŒ¯èª¤:", e); 
                document.getElementById('statusBox').innerText = "âŒ ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨";
                document.getElementById('statusBox').className = "status";
                document.getElementById('statusBox').style.backgroundColor = "gray";
            }
        }

        // æ¯ 1 ç§’æ›´æ–°ä¸€æ¬¡
        setInterval(updateData, 1000);
    </script>
</body>
</html>